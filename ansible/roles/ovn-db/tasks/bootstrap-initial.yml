---
- name: Bootstrap new cluster
  block:

    - name: Set bootstrap args fact for NB
      set_fact:
        ovn_nb_db_bootstrap_args: "{% if groups['ovn-nb-db'] | length > 1 and inventory_hostname != groups['ovn-nb-db'][0] %} --db-nb-cluster-remote-addr={{ 'api' | kolla_address(groups['ovn-nb-db'][0]) | put_address_in_context('url') }} {% endif %}"
      when: groups['ovn-nb-db_leader'] is not defined and groups['ovn-nb-db_follower'] is not defined

    - name: Set bootstrap args fact for SB
      set_fact:
        ovn_sb_db_bootstrap_args: "{% if groups['ovn-sb-db'] | length > 1 and inventory_hostname != groups['ovn-sb-db'][0] %} --db-sb-cluster-remote-addr={{ 'api' | kolla_address(groups['ovn-sb-db'][0]) | put_address_in_context('url') }} {% endif %}"
      when: groups['ovn-sb-db_leader'] is not defined and groups['ovn-sb-db_follower'] is not defined

    - import_tasks: config.yml

    - import_tasks: check-containers.yml

    - name: Flush handlers
      meta: flush_handlers

    - import_tasks: bootstrap-db.yml

    - name: Unset bootstrap args fact
      set_fact:
        ovn_nb_db_bootstrap_args:
        ovn_sb_db_bootstrap_args:

  when:
    - groups['ovn-nb-db_leader'] is not defined and groups['ovn-nb-db_follower'] is not defined
    - groups['ovn-sb-db_leader'] is not defined and groups['ovn-sb-db_follower'] is not defined

- name: Bootstrap additional nodes (when leader exists)
  block:

    - name: Set bootstrap args fact for NB
      set_fact:
        ovn_nb_db_bootstrap_args: "--db-nb-cluster-remote-addr={{ 'api' | kolla_address(groups.get('ovn-nb-db_leader', [])[0] | default()) | put_address_in_context('url') }}"
      when: inventory_hostname in groups.get('ovn-nb-db_had_volume_False', '') and groups['ovn-nb-db_leader'] is defined

    - name: Set bootstrap args fact for SB
      set_fact:
        ovn_sb_db_bootstrap_args: "--db-sb-cluster-remote-addr={{ 'api' | kolla_address(groups.get('ovn-sb-db_leader', [])[0] | default()) | put_address_in_context('url') }}"
      when: inventory_hostname in groups.get('ovn-sb-db_had_volume_False', '') and groups['ovn-sb-db_leader'] is defined

    - import_tasks: config.yml

    - import_tasks: check-containers.yml

    - name: Flush handlers
      meta: flush_handlers

    - import_tasks: bootstrap-db.yml

    - name: Unset bootstrap args fact
      set_fact:
        ovn_nb_db_bootstrap_args:
        ovn_sb_db_bootstrap_args:

  when:
    - inventory_hostname in groups.get('ovn-nb-db_had_volume_False', '') and groups['ovn-nb-db_leader'] is defined
    - inventory_hostname in groups.get('ovn-sb-db_had_volume_False', '') and groups['ovn-sb-db_leader'] is defined
